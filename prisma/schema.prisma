generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//
// ===== ENUMS =====
//

enum Role {
  ADMIN
  ORGANIZER
  USER
}

enum EventStatus {
  UPCOMING
  ONGOING
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}

enum PaymentMethod {
  CARD
  ESEWA
  KHALTI
  CASH
}

enum ImageType {
  AVATAR
  BANNER
  REFERENCE
  GALLERY
  HIGHLIGHT
}

enum VideoType {
  PROMO
  REFERENCE
  HIGHLIGHT
}

//
// ===== CORE MODELS =====
//

model RoleTable {
  id          String  @id @default(uuid())
  role_name   String  @unique
  description String?
  users       User[]
}

model User {
  id           String   @id @default(uuid())
  role_id      String?
  name         String
  email        String   @unique
  password     String
  avatarUrl_Id String?  @unique
  phone        String?
  createdAt    DateTime @default(now())

  // Relations
  role          RoleTable?      @relation(fields: [role_id], references: [id])
  avatarImage   Image?          @relation("AvatarImage", fields: [avatarUrl_Id], references: [id])
  events        Event[]         @relation("OrganizerEvents")
  tickets       Ticket[]
  payments      Payment[]
  feedbacks     Feedback[]
  notifications Notification[]
  surveys       Survey[]
  ads           Advertisement[]
  images        Image[]         @relation("UserImages")

  @@index([email])
}

model EventCategory {
  id          String  @id @default(uuid())
  name        String  @unique
  description String?
  events      Event[]
}

//
// ===== EVENT =====
//

model Event {
  id              String      @id @default(uuid())
  organizer_id    String
  category_id     String
  banner_image_id String?     @unique
  promo_video_id  String?     @unique
  title           String
  description     String
  event_type      String
  location        String
  start_date      DateTime
  end_date        DateTime
  status          EventStatus @default(UPCOMING)
  capacity        Int
  created_at      DateTime    @default(now())

  // Relations
  organizer   User          @relation("OrganizerEvents", fields: [organizer_id], references: [id])
  category    EventCategory @relation(fields: [category_id], references: [id])
  bannerImage Image?        @relation("BannerImage", fields: [banner_image_id], references: [id])
  promoVideo  Video?        @relation("PromoVideo", fields: [promo_video_id], references: [id])

  ticketTypes    TicketType[]
  tickets        Ticket[]
  feedbacks      Feedback[]
  sponsorships   Sponsorship[]
  surveys        Survey[]
  notifications  Notification[]
  advertisements Advertisement[]
  images         Image[]         @relation("EventImages")
  videos         Video[]         @relation("EventVideos")
}

//
// ===== TICKETING & PAYMENT =====
//

model TicketType {
  id          String  @id @default(uuid())
  event_id    String
  name        String
  description String?
  price       Float

  event   Event    @relation(fields: [event_id], references: [id])
  tickets Ticket[]
}

model Ticket {
  id          String   @id @default(uuid())
  event_id    String
  user_id     String
  type_id     String
  qr_code     String?
  badge_url   String?
  issue_date  DateTime @default(now())
  status      String
  isPurchased Boolean  @default(false) // <-- Correct placement

  event   Event      @relation(fields: [event_id], references: [id])
  user    User       @relation(fields: [user_id], references: [id])
  type    TicketType @relation(fields: [type_id], references: [id])
  payment Payment?
}

model Payment {
  id               String        @id @default(uuid())
  ticket_id        String        @unique
  user_id          String
  amount           Float
  payment_method   PaymentMethod
  payment_date     DateTime      @default(now())
  payment_status   PaymentStatus @default(PENDING)
  transaction_uuid String?       @unique  // Store eSewa's transaction ID
  signature        String?                // Optional for verification record

  ticket Ticket @relation(fields: [ticket_id], references: [id])
  user   User   @relation(fields: [user_id], references: [id])
}

//
// ===== FEEDBACK & SPONSORSHIP =====
//

model Feedback {
  id          String   @id @default(uuid())
  event_id    String
  user_id     String
  rating      Int
  comment     String?
  feedback_at DateTime @default(now())

  event Event @relation(fields: [event_id], references: [id])
  user  User  @relation(fields: [user_id], references: [id])
}

model Sponsorship {
  id            String  @id @default(uuid())
  event_id      String
  sponsor_name  String
  contribution  Float
  logo_url      String?
  contact_email String

  event  Event   @relation(fields: [event_id], references: [id])
  images Image[]
  videos Video[]
}

//
// ===== ADVERTISEMENT =====
//

model Advertisement {
  id           String   @id @default(uuid())
  event_id     String?
  organizer_id String
  title        String
  description  String?
  start_date   DateTime
  end_date     DateTime
  status       String

  organizer User    @relation(fields: [organizer_id], references: [id])
  event     Event?  @relation(fields: [event_id], references: [id])
  images    Image[]
  videos    Video[]
}

//
// ===== NOTIFICATIONS & SURVEYS =====
//

model Notification {
  id       String   @id @default(uuid())
  user_id  String
  event_id String?
  message  String
  type     String
  sent_at  DateTime @default(now())
  is_read  Boolean  @default(false)

  user  User   @relation(fields: [user_id], references: [id])
  event Event? @relation(fields: [event_id], references: [id])
}

model Survey {
  id           String   @id @default(uuid())
  event_id     String
  user_id      String
  question     String
  response     String?
  submitted_at DateTime @default(now())

  event Event @relation(fields: [event_id], references: [id])
  user  User  @relation(fields: [user_id], references: [id])
}

//
// ===== MEDIA MODELS =====
//

model Image {
  id          String    @id @default(uuid())
  event_id    String?
  user_id     String?
  ad_id       String?
  sponsor_id  String?
  image_url   String
  image_title String?
  image_type  ImageType
  uploaded_at DateTime  @default(now())

  event     Event?         @relation("EventImages", fields: [event_id], references: [id])
  user      User?          @relation("UserImages", fields: [user_id], references: [id])
  ad        Advertisement? @relation(fields: [ad_id], references: [id])
  sponsor   Sponsorship?   @relation(fields: [sponsor_id], references: [id])
  bannerFor Event?         @relation("BannerImage")

  avatarUser User? @relation("AvatarImage")
}

model Video {
  id          String    @id @default(uuid())
  event_id    String?
  ad_id       String?
  sponsor_id  String?
  video_url   String
  video_title String?
  video_type  VideoType
  duration    String?
  uploaded_at DateTime  @default(now())

  event    Event?         @relation("EventVideos", fields: [event_id], references: [id])
  ad       Advertisement? @relation(fields: [ad_id], references: [id])
  sponsor  Sponsorship?   @relation(fields: [sponsor_id], references: [id])
  promoFor Event?         @relation("PromoVideo")
}
